generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
enum ActivityType {
  CREATE_BOOKING
  UPDATE_BOOKING
  CREATE_BOOKING_ROOM
  UPDATE_BOOKING_ROOM
  CREATE_SERVICE_USAGE
  UPDATE_SERVICE_USAGE
  CREATE_TRANSACTION
  UPDATE_TRANSACTION
  CREATE_CUSTOMER
  CHECKED_IN
  CHECKED_OUT
  CREATE_PROMOTION
  UPDATE_PROMOTION
  CLAIM_PROMOTION
}

enum ServiceUsageStatus {
  PENDING
  TRANSFERRED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  PARTIALLY_CHECKED_OUT
  CHECKED_OUT
  CANCELLED
}

enum RoomStatus {
  AVAILABLE
  RESERVED
  OCCUPIED
  CLEANING
  MAINTENANCE
  OUT_OF_SERVICE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  E_WALLET
}

enum TransactionType {
  DEPOSIT
  ROOM_CHARGE
  SERVICE_CHARGE
  REFUND
  ADJUSTMENT
}

enum PromotionScope {
  ROOM
  SERVICE
  ALL
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CustomerPromotionStatus {
  AVAILABLE
  USED
  EXPIRED
}

// ==================== MODELS ====================

model Employee {
  id       String @id @default(cuid())
  name     String
  username String @unique
  password String
  role     String @default("STAFF") // ADMIN, RECEPTIONIST, HOUSEKEEPING

  transactions Transaction[]

  updatedAt     DateTime       @updatedAt
  serviceUsages ServiceUsage[]
  activities    Activity[]
}

model Customer {
  id       String  @id @default(cuid())
  fullName String
  email    String?
  phone    String  @unique
  idNumber String? // CMND/CCCD
  address  String? @db.Text
  password String

  bookings         Booking[]
  bookingCustomers BookingCustomer[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  activities         Activity[]
  customerPromotions CustomerPromotion[]

  @@index([phone])
}

model RoomType {
  id            String  @id @default(cuid())
  name          String
  capacity      Int
  totalBed      Int     @default(0)
  pricePerNight Decimal @db.Decimal(10, 2)

  rooms        Room[]
  bookingRooms BookingRoom[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  roomTypeTags RoomTypeTag[]
}

model RoomTag {
  id          String  @id @default(cuid())
  name        String  @unique // tivi, wifi, bếp
  description String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  roomTypeTags RoomTypeTag[]
}

model RoomTypeTag {
  id   String @id @default(cuid())
  name String @unique

  roomTypeId String
  roomTagId  String

  roomType RoomType @relation(fields: [roomTypeId], references: [id])
  roomTag  RoomTag  @relation(fields: [roomTagId], references: [id])
}

model Room {
  id         String     @id @default(cuid())
  roomNumber String     @unique
  floor      Int
  code       String     @default("")
  status     RoomStatus @default(AVAILABLE)
  roomTypeId String

  roomType     RoomType      @relation(fields: [roomTypeId], references: [id])
  bookingRooms BookingRoom[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

model Booking {
  id          String        @id @default(cuid())
  bookingCode String        @unique
  status      BookingStatus @default(PENDING)

  primaryCustomerId String
  primaryCustomer   Customer @relation(fields: [primaryCustomerId], references: [id])

  checkInDate  DateTime
  checkOutDate DateTime

  totalGuests Int

  // TÀI CHÍNH TỔNG QUÁT (Tổng hợp từ BookingRooms)
  totalAmount     Decimal @default(0) @db.Decimal(10, 2)
  depositRequired Decimal @default(0) @db.Decimal(10, 2)
  totalDeposit    Decimal @default(0) @db.Decimal(10, 2)
  totalPaid       Decimal @default(0) @db.Decimal(10, 2)
  balance         Decimal @default(0) @db.Decimal(10, 2)

  bookingRooms     BookingRoom[]
  bookingCustomers BookingCustomer[]
  transactions     Transaction[]
  serviceUsages    ServiceUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingCode])
  @@index([status])
}

model BookingRoom {
  id         String @id @default(cuid())
  bookingId  String
  roomId     String
  roomTypeId String

  checkInDate    DateTime
  checkOutDate   DateTime
  actualCheckIn  DateTime?
  actualCheckOut DateTime?

  pricePerNight   Decimal @db.Decimal(10, 2)
  depositAmount   Decimal @default(0) @db.Decimal(10, 2)
  subtotalRoom    Decimal @default(0) @db.Decimal(10, 2)
  subtotalService Decimal @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal @default(0) @db.Decimal(10, 2)
  totalPaid       Decimal @default(0) @db.Decimal(10, 2)
  balance         Decimal @default(0) @db.Decimal(10, 2)

  status BookingStatus @default(PENDING)

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  room     Room     @relation(fields: [roomId], references: [id])
  roomType RoomType @relation(fields: [roomTypeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookingCustomers   BookingCustomer[]
  serviceUsages      ServiceUsage[]
  transactionDetails TransactionDetail[]
  activities         Activity[]

  @@index([status])
}

model BookingCustomer {
  id            String  @id @default(cuid())
  bookingId     String
  customerId    String
  bookingRoomId String?

  isPrimary Boolean @default(false)

  booking     Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customerId], references: [id])
  bookingRoom BookingRoom? @relation(fields: [bookingRoomId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bookingId, customerId])
}

model Transaction {
  id        String  @id @default(cuid())
  bookingId String?

  type TransactionType

  baseAmount     Decimal @db.Decimal(10, 2)
  discountAmount Decimal @db.Decimal(10, 2)
  amount         Decimal @db.Decimal(10, 2)

  method PaymentMethod?
  status TransactionStatus @default(PENDING)

  processedById String?
  processedBy   Employee? @relation(fields: [processedById], references: [id])

  // Quan hệ tới chi tiết thanh toán
  details TransactionDetail[]

  transactionRef String?
  occurredAt     DateTime @default(now())
  description    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking        Booking?        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  usedPromotions UsedPromotion[]
}

model TransactionDetail {
  id            String  @id @default(cuid())
  transactionId String? // Optional - null for guest service payments

  // Số tiền phân bổ cho khoản mục này
  baseAmount     Decimal @db.Decimal(10, 2)
  discountAmount Decimal @db.Decimal(10, 2)
  amount         Decimal @db.Decimal(10, 2)

  // Liên kết tới cái cần thanh toán (Một trong hai cái này sẽ có giá trị)
  bookingRoomId  String? // Nếu thanh toán tiền phòng
  serviceUsageId String? // Nếu thanh toán dịch vụ cụ thể

  transaction  Transaction?  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  bookingRoom  BookingRoom?  @relation(fields: [bookingRoomId], references: [id])
  serviceUsage ServiceUsage? @relation(fields: [serviceUsageId], references: [id])

  createdAt          DateTime            @default(now())
  customerPromotions CustomerPromotion[]
  usedPromotions     UsedPromotion[]
}

model Service {
  id       String  @id @default(cuid())
  name     String
  price    Decimal @db.Decimal(10, 2)
  unit     String  @default("lần")
  isActive Boolean @default(true)

  serviceUsages ServiceUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceUsage {
  id            String  @id @default(cuid())
  bookingId     String?
  bookingRoomId String?
  employeeId    String

  serviceId  String
  quantity   Int     @default(1)
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2) // Total cost (unitPrice × quantity)
  totalPaid  Decimal @default(0) @db.Decimal(10, 2) // Amount paid so far
  // balance = totalPrice - totalPaid (calculated field, not stored)

  status ServiceUsageStatus @default(PENDING)

  booking     Booking?     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingRoom BookingRoom? @relation(fields: [bookingRoomId], references: [id])
  service     Service      @relation(fields: [serviceId], references: [id])
  employee    Employee     @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactionDetails TransactionDetail[]
  activities         Activity[]
}

model Activity {
  id   String       @id @default(cuid())
  type ActivityType

  metadata    Json?
  description String @default("")

  serviceUsageId String?
  bookingRoomId  String?
  customerId     String?
  employeeId     String?

  serviceUsage ServiceUsage? @relation(fields: [serviceUsageId], references: [id])
  bookingRoom  BookingRoom?  @relation(fields: [bookingRoomId], references: [id])
  customer     Customer?     @relation(fields: [customerId], references: [id])
  employee     Employee?     @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Promotion {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  type        PromotionType
  scope       PromotionScope @default(ALL)
  value       Decimal        @db.Decimal(10, 2)
  maxDiscount Decimal?       @db.Decimal(10, 2)

  minBookingAmount Decimal  @default(0) @db.Decimal(10, 2)
  startDate        DateTime
  endDate          DateTime

  totalQty     Int? // null = không giới hạn tổng
  remainingQty Int? // null = không giới hạn tổng

  perCustomerLimit Int @default(1)

  disabledAt DateTime?

  customerPromotions CustomerPromotion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usedPromotions UsedPromotion[]
}

model CustomerPromotion {
  id          String                  @id @default(cuid())
  customerId  String
  promotionId String
  status      CustomerPromotionStatus @default(AVAILABLE)

  claimedAt DateTime  @default(now())
  usedAt    DateTime?

  customer  Customer  @relation(fields: [customerId], references: [id])
  promotion Promotion @relation(fields: [promotionId], references: [id])

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  transactionDetail   TransactionDetail? @relation(fields: [transactionDetailId], references: [id])
  transactionDetailId String?
}

model UsedPromotion {
  id          String @id @default(cuid())
  promotionId String

  discountAmount Decimal @db.Decimal(10, 2)

  transactionDetailId String
  transactionId       String?

  transactionDetail TransactionDetail @relation(fields: [transactionDetailId], references: [id])
  transaction       Transaction?      @relation(fields: [transactionId], references: [id])

  promotion Promotion @relation(fields: [promotionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
